<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Guess the Impostor – Host & Player</title>
  <style>
    /* ... keep previous styles ... */
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Guess the Impostor</h1>
    <p class="small">Host tool to generate per‑player <strong>secret question links</strong>. Players can reuse the same personal link across rounds.</p>

    <div id="host" class="card">
      <!-- host settings -->
      <div class="grid two">
        <div>
          <label>Game name</label>
          <input id="gameName" type="text" placeholder="Friday Night Round" value="Friday Night Round"/>
        </div>
        <div>
          <label>Number of players</label>
          <input id="playerCount" type="number" min="2" max="20" value="6"/>
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid two">
        <div>
          <label>Common question</label>
          <textarea id="qCommon"></textarea>
        </div>
        <div>
          <label>Impostor question</label>
          <textarea id="qImp"></textarea>
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid two">
        <div>
          <label>Player names</label>
          <div id="names" class="grid three"></div>
        </div>
        <div>
          <label>Choose impostor</label>
          <div id="impPick" class="grid three"></div>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="randomImp">Randomize Impostor</button>
            <span id="impBadge" class="chip">No impostor picked yet</span>
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <label class="chip"><input id="stealth" type="checkbox" style="margin-right:8px"> Stealth impostor (players don't see role)</label>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="gen" class="btn">Update Questions</button>
        <button id="reset" class="btn ghost">Reset</button>
      </div>

      <div id="linksWrap" class="hidden">
      <h2>Share with players</h2>
      <p class="small">Option A: one link for everyone + a Round Code each round. Option B: per-player stable links (old flow).</p>

      <div class="card" style="margin-bottom:10px">
        <h3>Option A — Single link</h3>
        <div class="linkline">
          <span id="singleLink" class="mono"></span>
          <div class="row"><button id="copySingle" class="btn ghost">Copy link</button></div>
        </div>
        <div class="linkline" style="margin-top:8px">
          <span id="roundCode" class="mono"></span>
          <div class="row"><button id="copyRound" class="btn ghost">Copy code</button></div>
        </div>
        <p class="small">Players open the link, type their name, and paste this round code.</p>
      </div>

      <h3>Option B — Per-player links</h3>
      <div id="links" class="list"></div>
    </div>

    <div id="playerView" class="card hidden" style="margin-top:16px">
      <div class="center">
        <div id="rolePill" class="pill hidden">role</div>
        <h2 id="pvGame">Game</h2>
      </div>
      <div class="notice">Private screen. Tap reveal when ready.</div>
      <div id="joinWrap" class="hidden" style="margin:10px 0">
        <label>Your name</label>
        <input id="joinName" type="text" placeholder="Type your name"/>
        <label style="margin-top:8px; display:block;">Round Code</label>
        <div class="row">
          <input id="roundCodeInput" type="text" placeholder="Paste code from host"/>
          <button id="loadRound" class="btn">Load</button>
        </div>
        <p class="small muted">Use the single shared link + the host's Round Code.</p>
      </div>
      <div class="center" style="margin:10px 0 16px">
        <button id="revealBtn" class="btn">Reveal my question</button>
        <button id="hideBtn" class="btn ghost hidden">Hide</button>
      </div>
      <div id="questionBox" class="hidden">
        <h3>Your question</h3>
        <div id="pvQ" style="font-size:18px;line-height:1.5"></div>
      </div>
    </div>
  </div>

  <script>
    const b64u = {
      enc: (obj) => {
        const s = JSON.stringify(obj);
        return btoa(unescape(encodeURIComponent(s))).replaceAll('+','-').replaceAll('/','_').replace(/=+$/,'');
      },
      dec: (str) => {
        const pad = str + '==='.slice((str.length + 3) % 4);
        const s = decodeURIComponent(escape(atob(pad.replaceAll('-','+').replaceAll('_','/'))));
        return JSON.parse(s);
      }
    };

    const el=(id)=>document.getElementById(id);
    const namesWrap=el('names');
    const impPick=el('impPick');
    const playerCount=el('playerCount');
    const impBadge=el('impBadge');
    let selectedImp=null;

    function rebuildPlayers(){
      namesWrap.innerHTML='';
      impPick.innerHTML='';
      const n=Math.max(2,Math.min(20,parseInt(playerCount.value||6)));
      for(let i=0;i<n;i++){
        const name=document.createElement('input');
        name.type='text';
        name.placeholder=`Player ${i+1}`;
        name.dataset.idx=i;
        namesWrap.appendChild(name);
        const btn=document.createElement('button');
        btn.className='btn ghost';
        btn.textContent=`Pick ${i+1}`;
        btn.onclick=()=>pickImp(i);
        impPick.appendChild(btn);
      }
      if(selectedImp==null||selectedImp>=n){selectedImp=null;impBadge.textContent='No impostor picked yet';impBadge.className='chip';}
    }
    function pickImp(i){selectedImp=i;impBadge.textContent=`Impostor: Player ${i+1}`;impBadge.className='chip role-imp';}
    el('randomImp').onclick=()=>{const n=Math.max(2,Math.min(20,parseInt(playerCount.value||6)));pickImp(Math.floor(Math.random()*n));};
    playerCount.addEventListener('input',rebuildPlayers);
    rebuildPlayers();

    function getNames(){return Array.from(namesWrap.querySelectorAll('input')).map((i,idx)=>i.value.trim()||`Player ${idx+1}`);}

    el('gen').onclick=()=>{
      const game=el('gameName').value.trim()||'Round';
      const qCommon=el('qCommon').value.trim();
      const qImp=el('qImp').value.trim();
      const names=getNames();
      if(!qCommon||!qImp){alert('Please fill both questions.');return;}
      if(selectedImp==null){alert('Pick an impostor.');return;}
      const base=location.origin+location.pathname;
      const links=names.map((nm,idx)=>{
        const id=nm.replace(/\s+/g,'_')+"_"+idx; // stable id
        const isImp=idx===selectedImp;
        const stealth=el('stealth').checked;
        const payload={ id, g:game, q:(isImp?qImp:qCommon), n:nm };
        if(!stealth) payload.role=isImp?'impostor':'crew';
        const url=base+"#pid="+id;
        localStorage.setItem("impostorPayload_"+id,JSON.stringify(payload));
        return {nm,url,isImp};
      });
      renderLinks(links);
      const single = location.origin + location.pathname + '#join';
      const rcObj = {
        g: game,
        qc: qCommon,
        qi: qImp,
        impName: getNames()[selectedImp] || ('Player ' + (selectedImp + 1)),
        stealth: el('stealth').checked,
        t: Date.now()
      };
      const rc = b64u.enc(rcObj);

      // Write to UI
      const singleEl = document.getElementById('singleLink');
      const roundEl = document.getElementById('roundCode');
      const copySingle = document.getElementById('copySingle');
      const copyRound = document.getElementById('copyRound');
      if (singleEl && roundEl) {
        singleEl.textContent = single;
        roundEl.textContent = rc;
        if (copySingle) copySingle.onclick = async () => {
          try { await navigator.clipboard.writeText(single); copySingle.textContent='Copied!'; setTimeout(()=>copySingle.textContent='Copy link',1200);} catch(e){ prompt('Copy link:', single); }
        };
        if (copyRound) copyRound.onclick = async () => {
          try { await navigator.clipboard.writeText(rc); copyRound.textContent='Copied!'; setTimeout(()=>copyRound.textContent='Copy code',1200);} catch(e){ prompt('Copy code:', rc); }
        };
      }
      el('linksWrap').classList.remove('hidden');
    };

    function renderLinks(list){
      const box=el('links');
      box.innerHTML='';
      list.forEach(({nm,url,isImp})=>{
        const line=document.createElement('div');
        line.className='linkline';
        line.innerHTML=`<span><strong>${nm}</strong></span><a href="${url}" target="_blank">Open link</a>`;
        box.appendChild(line);
      });
    }

    el('reset').onclick=()=>{el('qCommon').value='';el('qImp').value='';selectedImp=null;impBadge.textContent='No impostor picked yet';impBadge.className='chip';el('linksWrap').classList.add('hidden');};

    function initPlayer(){
      const hash=new URL(location.href).hash;
      const norm = s => (s||'').trim().toLowerCase();
      if (hash.startsWith('#join')) {
        // One link flow: show join UI and wait for round code
        el('host').classList.add('hidden');
        el('playerView').classList.remove('hidden');
        const joinWrap = document.getElementById('joinWrap');
        if (joinWrap) joinWrap.classList.remove('hidden');

        const qBox = el('pvQ');
        const pill = el('rolePill');

        const applyRound = (roundObj, playerName) => {
          if (!roundObj || !playerName) return;
          const youAreImp = norm(playerName) === norm(roundObj.impName);
          if (roundObj.g) el('pvGame').textContent = roundObj.g;
          // Stealth: only show role if host didn't turn on stealth
          if (!roundObj.stealth) {
            pill.classList.remove('hidden');
            pill.textContent = (youAreImp ? 'IMPOSTOR' : 'CREW') + (playerName ? ` • ${playerName}` : '');
            pill.className = 'pill ' + (youAreImp ? 'role-imp' : 'role-crew');
          } else {
            pill.classList.add('hidden');
          }
          qBox.textContent = youAreImp ? (roundObj.qi || '(no question)') : (roundObj.qc || '(no question)');
        };

        // Load button handler
        const loadBtn = document.getElementById('loadRound');
        loadBtn.onclick = () => {
          try {
            const playerName = document.getElementById('joinName').value;
            const codeText = document.getElementById('roundCodeInput').value.trim();
            const roundObj = b64u.dec(codeText);
            applyRound(roundObj, playerName);
            // Ready to reveal/hide
            el('revealBtn').onclick = () => { el('questionBox').classList.remove('hidden'); el('revealBtn').classList.add('hidden'); el('hideBtn').classList.remove('hidden'); };
            el('hideBtn').onclick = () => { el('questionBox').classList.add('hidden'); el('revealBtn').classList.remove('hidden'); el('hideBtn').classList.add('hidden'); };
          } catch (e) {
            alert('Invalid Round Code');
          }
        };

        return; // stop here; we handled the join path
      }
      if(!(hash.startsWith('#pid=') || hash.startsWith('#join'))) return;
      const id=hash.slice(5);
      const data=localStorage.getItem("impostorPayload_"+id);
      if(!data) return;
      const payload=JSON.parse(data);
      el('host').classList.add('hidden');
      el('playerView').classList.remove('hidden');
      el('pvGame').textContent=payload.g||'Game';
      const pill=el('rolePill');
      if(payload.role){pill.classList.remove('hidden');pill.textContent=(payload.role==='impostor'?'IMPOSTOR':'CREW')+(payload.n?` • ${payload.n}`:'');}
      else{pill.classList.add('hidden');}
      const qBox=el('pvQ');
      qBox.textContent=payload.q||'(no question)';
      el('revealBtn').onclick=()=>{el('questionBox').classList.remove('hidden');el('revealBtn').classList.add('hidden');el('hideBtn').classList.remove('hidden');};
      el('hideBtn').onclick=()=>{el('questionBox').classList.add('hidden');el('revealBtn').classList.remove('hidden');el('hideBtn').classList.add('hidden');};
    }
    initPlayer();
  </script>
</body>
</html>
