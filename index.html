<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Guess the Impostor – Host & Player</title>
  <style>
    /* ... keep previous styles ... */
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Guess the Impostor</h1>
    <p class="small">Host tool to generate per‑player <strong>secret question links</strong>. Players can reuse the same personal link across rounds.</p>

    <div id="host" class="card">
      <!-- host settings -->
      <div class="grid two">
        <div>
          <label>Game name</label>
          <input id="gameName" type="text" placeholder="Friday Night Round" value="Friday Night Round"/>
        </div>
        <div>
          <label>Number of players</label>
          <input id="playerCount" type="number" min="2" max="20" value="6"/>
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid two">
        <div>
          <label>Common question</label>
          <textarea id="qCommon"></textarea>
        </div>
        <div>
          <label>Impostor question</label>
          <textarea id="qImp"></textarea>
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid two">
        <div>
          <label>Player names</label>
          <div id="names" class="grid three"></div>
        </div>
        <div>
          <label>Choose impostor</label>
          <div id="impPick" class="grid three"></div>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="randomImp">Randomize Impostor</button>
            <span id="impBadge" class="chip">No impostor picked yet</span>
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <label class="chip"><input id="stealth" type="checkbox" style="margin-right:8px"> Stealth impostor (players don't see role)</label>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="gen" class="btn">Update Questions</button>
        <button id="reset" class="btn ghost">Reset</button>
      </div>

      <div id="linksWrap" class="hidden">
        <h2>Player Links (stable)</h2>
        <p class="small">These links never change. Players can bookmark and reuse the same link each round. Host just updates questions, and each link shows the new secret.</p>
        <div id="links" class="list"></div>
      </div>
    </div>

    <div id="playerView" class="card hidden" style="margin-top:16px">
      <div class="center">
        <div id="rolePill" class="pill hidden">role</div>
        <h2 id="pvGame">Game</h2>
      </div>
      <div class="notice">Private screen. Tap reveal when ready.</div>
      <div class="center" style="margin:10px 0 16px">
        <button id="revealBtn" class="btn">Reveal my question</button>
        <button id="hideBtn" class="btn ghost hidden">Hide</button>
      </div>
      <div id="questionBox" class="hidden">
        <h3>Your question</h3>
        <div id="pvQ" style="font-size:18px;line-height:1.5"></div>
      </div>
    </div>
  </div>

  <script>
    const b64u = {
      enc: (obj) => {
        const s = JSON.stringify(obj);
        return btoa(unescape(encodeURIComponent(s))).replaceAll('+','-').replaceAll('/','_').replace(/=+$/,'');
      },
      dec: (str) => {
        const pad = str + '==='.slice((str.length + 3) % 4);
        const s = decodeURIComponent(escape(atob(pad.replaceAll('-','+').replaceAll('_','/'))));
        return JSON.parse(s);
      }
    };

    const el=(id)=>document.getElementById(id);
    const namesWrap=el('names');
    const impPick=el('impPick');
    const playerCount=el('playerCount');
    const impBadge=el('impBadge');
    let selectedImp=null;

    function rebuildPlayers(){
      namesWrap.innerHTML='';
      impPick.innerHTML='';
      const n=Math.max(2,Math.min(20,parseInt(playerCount.value||6)));
      for(let i=0;i<n;i++){
        const name=document.createElement('input');
        name.type='text';
        name.placeholder=`Player ${i+1}`;
        name.dataset.idx=i;
        namesWrap.appendChild(name);
        const btn=document.createElement('button');
        btn.className='btn ghost';
        btn.textContent=`Pick ${i+1}`;
        btn.onclick=()=>pickImp(i);
        impPick.appendChild(btn);
      }
      if(selectedImp==null||selectedImp>=n){selectedImp=null;impBadge.textContent='No impostor picked yet';impBadge.className='chip';}
    }
    function pickImp(i){selectedImp=i;impBadge.textContent=`Impostor: Player ${i+1}`;impBadge.className='chip role-imp';}
    el('randomImp').onclick=()=>{const n=Math.max(2,Math.min(20,parseInt(playerCount.value||6)));pickImp(Math.floor(Math.random()*n));};
    playerCount.addEventListener('input',rebuildPlayers);
    rebuildPlayers();

    function getNames(){return Array.from(namesWrap.querySelectorAll('input')).map((i,idx)=>i.value.trim()||`Player ${idx+1}`);}

    el('gen').onclick=()=>{
      const game=el('gameName').value.trim()||'Round';
      const qCommon=el('qCommon').value.trim();
      const qImp=el('qImp').value.trim();
      const names=getNames();
      if(!qCommon||!qImp){alert('Please fill both questions.');return;}
      if(selectedImp==null){alert('Pick an impostor.');return;}
      const base=location.origin+location.pathname;
      const links=names.map((nm,idx)=>{
        const id=nm.replace(/\s+/g,'_')+"_"+idx; // stable id
        const isImp=idx===selectedImp;
        const stealth=el('stealth').checked;
        const payload={ id, g:game, q:(isImp?qImp:qCommon), n:nm };
        if(!stealth) payload.role=isImp?'impostor':'crew';
        const url=base+"#pid="+id;
        localStorage.setItem("impostorPayload_"+id,JSON.stringify(payload));
        return {nm,url,isImp};
      });
      renderLinks(links);
      el('linksWrap').classList.remove('hidden');
    };

    function renderLinks(list){
      const box=el('links');
      box.innerHTML='';
      list.forEach(({nm,url,isImp})=>{
        const line=document.createElement('div');
        line.className='linkline';
        line.innerHTML=`<span><strong>${nm}</strong></span><a href="${url}" target="_blank">Open link</a>`;
        box.appendChild(line);
      });
    }

    el('reset').onclick=()=>{el('qCommon').value='';el('qImp').value='';selectedImp=null;impBadge.textContent='No impostor picked yet';impBadge.className='chip';el('linksWrap').classList.add('hidden');};

    function initPlayer(){
      const hash=new URL(location.href).hash;
      if(!hash.startsWith('#pid='))return;
      const id=hash.slice(5);
      const data=localStorage.getItem("impostorPayload_"+id);
      if(!data) return;
      const payload=JSON.parse(data);
      el('host').classList.add('hidden');
      el('playerView').classList.remove('hidden');
      el('pvGame').textContent=payload.g||'Game';
      const pill=el('rolePill');
      if(payload.role){pill.classList.remove('hidden');pill.textContent=(payload.role==='impostor'?'IMPOSTOR':'CREW')+(payload.n?` • ${payload.n}`:'');}
      else{pill.classList.add('hidden');}
      const qBox=el('pvQ');
      qBox.textContent=payload.q||'(no question)';
      el('revealBtn').onclick=()=>{el('questionBox').classList.remove('hidden');el('revealBtn').classList.add('hidden');el('hideBtn').classList.remove('hidden');};
      el('hideBtn').onclick=()=>{el('questionBox').classList.add('hidden');el('revealBtn').classList.remove('hidden');el('hideBtn').classList.add('hidden');};
    }
    initPlayer();
  </script>
</body>
</html>
