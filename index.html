<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Guess the Impostor – Host & Player</title>
  <style>
    :root { --bg:#0f1226; --card:#171a36; --muted:#9aa4ff; --text:#e8eaff; --accent:#7cf; --danger:#ff6b6b }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:radial-gradient(1200px 800px at 100% -10%,#1a2050 0%,#0f1226 60%),var(--bg);color:var(--text)}
    .wrap{max-width:980px;margin:0 auto;padding:28px}
    h1{font-size:28px;margin:0 0 6px}
    h2{font-size:20px;margin:20px 0 10px;color:#c9ccff}
    h3{margin:8px 0;color:#c9ccff}
    p.small{opacity:.85;font-size:14px;margin:.25rem 0 1rem}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.09);border-radius:18px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .grid{display:grid;gap:14px}
    .grid.two{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.three{grid-template-columns:repeat(3,minmax(0,1fr))}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input[type="text"], textarea, input[type="number"], select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#121432;color:var(--text);outline:none}
    textarea{min-height:92px;resize:vertical}
    input::placeholder, textarea::placeholder{color:#aab}
    .btn{appearance:none;border:none;background:linear-gradient(180deg,#5fd 0%,#49c 100%);color:#08131e;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:0 6px 18px rgba(120,220,255,.35);transition:transform .05s ease}
    .btn:active{transform:translateY(1px)}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(124,255,255,.5)}
    .pill{padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.15)}
    .role-imp{background:#31121a;border-color:#ff9aaa;color:#ffc6d0}
    .role-crew{background:#10281e;border-color:#96ffc6;color:#c8ffe6}
    .chip{display:inline-flex;align-items:center;gap:6px;background:#121432;border:1px dashed rgba(255,255,255,.15);color:#bcd;padding:6px 10px;border-radius:999px;font-size:12px}
    .linkline{display:flex;gap:8px;align-items:center;justify-content:space-between;background:#0e1230;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px}
    .linkline > span{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .hidden{display:none}
    .hr{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.15),transparent);margin:14px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Guess the Impostor</h1>
    <p class="small">Host shares a single link. Players choose their name <em>inside</em> the page and paste a round code to reveal their private question.</p>

    <div id="host" class="card">
      <div class="grid two">
        <div>
          <label>Game name</label>
          <input id="gameName" type="text" value="Friday Night Round"/>
        </div>
        <div>
          <label>Number of players</label>
          <input id="playerCount" type="number" min="2" max="20" value="6"/>
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid two">
        <div>
          <label>Common question</label>
          <textarea id="qCommon" placeholder="e.g., What's a movie you rewatch?"></textarea>
        </div>
        <div>
          <label>Impostor question</label>
          <textarea id="qImp" placeholder="e.g., What's a movie you refuse to watch?"></textarea>
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid two">
        <div>
          <label>Player names (optional, used for the join list)</label>
          <div id="names" class="grid three"></div>
        </div>
        <div>
          <label>Choose impostor</label>
          <div id="impPick" class="grid three"></div>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="randomImp">Randomize Impostor</button>
            <span id="impBadge" class="chip">No impostor picked yet</span>
          </div>
          <div class="row" style="margin-top:10px">
            <label class="chip"><input id="stealth" type="checkbox" style="margin-right:8px"> Stealth impostor (players don't see role)</label>
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <button id="gen" class="btn">Start / Update Round</button>
        <button id="reset" class="btn ghost">Reset</button>
      </div>

      <div id="linksWrap" class="hidden">
        <h2>Single Game Link & Round Code</h2>
        <p class="small">Share this one link with everyone. Then share the round code each round. Players pick their name inside and paste the code.</p>
        <div class="linkline">
          <span id="singleLink" class="mono"></span>
          <div class="row"><button id="copySingle" class="btn ghost">Copy link</button></div>
        </div>
        <div class="linkline" style="margin-top:8px">
          <span id="roundCode" class="mono"></span>
          <div class="row"><button id="copyRound" class="btn ghost">Copy code</button></div>
        </div>
      </div>
    </div>

    <div id="playerView" class="card hidden" style="margin-top:16px">
      <div class="center">
        <div id="rolePill" class="pill hidden">role</div>
        <h2 id="pvGame">Game</h2>
      </div>
      <div class="notice" style="margin:10px 0">
        <strong>Private Screen:</strong> Paste code → pick your name → tap Reveal when ready.
      </div>

      <div id="joinWrap" style="margin:10px 0">
        <div class="grid two">
          <div>
            <label>Round Code</label>
            <input id="roundCodeInput" type="text" placeholder="Paste code from host"/>
          </div>
          <div>
            <label>Your name</label>
            <select id="nameSelect"></select>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="loadRound" class="btn">Load round</button>
        </div>
      </div>

      <div class="center" style="margin:10px 0 16px">
        <button id="revealBtn" class="btn hidden">Reveal my question</button>
        <button id="hideBtn" class="btn ghost hidden">Hide</button>
      </div>
      <div id="questionBox" class="hidden">
        <h3>Your question</h3>
        <div id="pvQ" style="font-size:18px;line-height:1.5"></div>
      </div>
    </div>
  </div>

  <script>
    // --- Base64URL helpers ---
    const b64u = {
      enc: (obj) => {
        const s = JSON.stringify(obj);
        return btoa(unescape(encodeURIComponent(s))).replaceAll('+','-').replaceAll('/','_').replace(/=+$/,'');
      },
      dec: (str) => {
        const pad = str + '==='.slice((str.length + 3) % 4);
        const s = decodeURIComponent(escape(atob(pad.replaceAll('-','+').replaceAll('_','/'))));
        return JSON.parse(s);
      }
    };

    const el = (id)=>document.getElementById(id);

    // --- Host: names + impostor pick ---
    const namesWrap = el('names');
    const impPick = el('impPick');
    const playerCount = el('playerCount');
    const impBadge = el('impBadge');
    let selectedImp = null;

    function rebuildUI(){
      // Names
      namesWrap.innerHTML='';
      impPick.innerHTML='';
      const n = Math.max(2, Math.min(20, parseInt(playerCount.value||6)));
      for(let i=0;i<n;i++){
        const name = document.createElement('input');
        name.type='text';
        name.placeholder=`Player ${i+1}`;
        name.dataset.idx=i;
        namesWrap.appendChild(name);

        const btn = document.createElement('button');
        btn.className='btn ghost';
        btn.textContent=`Pick ${i+1}`;
        btn.onclick=()=>pickImp(i);
        impPick.appendChild(btn);
      }
      if(selectedImp==null || selectedImp>=n) { selectedImp=null; setBadge(); }
    }

    function setBadge(){
      if(selectedImp==null){ impBadge.textContent='No impostor picked yet'; impBadge.className='chip'; }
      else { impBadge.textContent=`Impostor: Player ${selectedImp+1}`; impBadge.className='chip role-imp'; }
    }

    function pickImp(i){ selectedImp=i; setBadge(); }

    el('randomImp').onclick=()=>{
      const n = Math.max(2, Math.min(20, parseInt(playerCount.value||6)));
      pickImp(Math.floor(Math.random()*n));
    };

    playerCount.addEventListener('input', rebuildUI);
    rebuildUI();

    function getNames(){
      const inputs = Array.from(namesWrap.querySelectorAll('input'));
      return inputs.map((inp,idx)=> inp.value.trim()||`Player ${idx+1}`);
    }

    // --- Host: Generate link + round code ---
    el('gen').onclick=()=>{
      const game = el('gameName').value.trim()||'Round';
      const qCommon = el('qCommon').value.trim();
      const qImp = el('qImp').value.trim();
      const names = getNames();
      if(!qCommon || !qImp){ alert('Please fill both questions.'); return; }
      if(selectedImp==null){ alert('Pick an impostor.'); return; }

      const stealth = el('stealth').checked;
      const roundObj = { g: game, qc: qCommon, qi: qImp, names, imp: selectedImp, stealth, t: Date.now() };
      const code = b64u.enc(roundObj);
      const single = location.origin + location.pathname + '#join';

      // Show single link & code
      el('linksWrap').classList.remove('hidden');
      el('singleLink').textContent = single;
      el('roundCode').textContent = code;
      el('copySingle').onclick = async()=>{ try{ await navigator.clipboard.writeText(single); el('copySingle').textContent='Copied!'; setTimeout(()=>el('copySingle').textContent='Copy link',1200);}catch(e){ prompt('Copy link:', single);} };
      el('copyRound').onclick = async()=>{ try{ await navigator.clipboard.writeText(code); el('copyRound').textContent='Copied!'; setTimeout(()=>el('copyRound').textContent='Copy code',1200);}catch(e){ prompt('Copy code:', code);} };
    };

    el('reset').onclick=()=>{ el('qCommon').value=''; el('qImp').value=''; selectedImp=null; setBadge(); el('linksWrap').classList.add('hidden'); };

    // --- Player: one-link join flow ---
    function initPlayer(){
      const hash = new URL(location.href).hash;
      if(!hash.startsWith('#join')) return; // only activate on shared link

      el('host').classList.add('hidden');
      el('playerView').classList.remove('hidden');

      const nameSel = el('nameSelect');
      nameSel.innerHTML = '<option value="" disabled selected>Load the round first</option>';

      const pill = el('rolePill');
      const qBox = el('pvQ');
      let roundObj = null;

      function applyRoundToUI(){
        if(!roundObj) return;
        el('pvGame').textContent = roundObj.g || 'Game';
        // populate names dropdown
        nameSel.innerHTML = '';
        (roundObj.names||[]).forEach((nm,idx)=>{
          const o=document.createElement('option');
          o.value=String(idx); o.textContent=nm; nameSel.appendChild(o);
        });
        const other=document.createElement('option'); other.value='__other__'; other.textContent='Not in list…'; nameSel.appendChild(other);
        el('revealBtn').classList.add('hidden');
        el('hideBtn').classList.add('hidden');
        el('questionBox').classList.add('hidden');
        qBox.textContent='';
      }

      // Load round code
      el('loadRound').onclick = ()=>{
        try { roundObj = b64u.dec(el('roundCodeInput').value.trim()); applyRoundToUI(); }
        catch(e){ alert('Invalid round code'); }
      };

      // When player is ready, compute their question
      el('revealBtn').onclick = ()=>{
        el('questionBox').classList.remove('hidden');
        el('revealBtn').classList.add('hidden');
        el('hideBtn').classList.remove('hidden');
      };
      el('hideBtn').onclick = ()=>{
        el('questionBox').classList.add('hidden');
        el('revealBtn').classList.remove('hidden');
        el('hideBtn').classList.add('hidden');
      };

      // When user picks name and loads round, decide question/role
      el('nameSelect').addEventListener('change', ()=>{
        if(!roundObj) { alert('Paste and load the round code first.'); return; }
        const v = el('nameSelect').value;
        let isImp=false; let displayName='';
        if(v==='__other__'){
          const nm = prompt('Enter your name');
          if(!nm){ return; }
          displayName = nm.trim();
          isImp = false; // names outside list are always crew to avoid accidental reveals
        } else {
          const idx = parseInt(v,10);
          displayName = (roundObj.names||[])[idx] || `Player ${idx+1}`;
          isImp = (idx === roundObj.imp);
        }
        if(!roundObj.stealth){
          pill.classList.remove('hidden');
          pill.textContent = (isImp? 'IMPOSTOR':'CREW') + (displayName?` • ${displayName}`:'');
          pill.className = 'pill ' + (isImp? 'role-imp':'role-crew');
        } else {
          pill.classList.add('hidden');
        }
        el('revealBtn').classList.remove('hidden');
        const q = isImp ? roundObj.qi : roundObj.qc;
        el('pvQ').textContent = q || '(no question)';
      });
    }
    initPlayer();
  </script>
</body>
</html>